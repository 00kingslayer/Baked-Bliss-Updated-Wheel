<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baked Bliss - Spin & Win!</title>

    <!-- === PERMANENT CACHE FIX === -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Responsive Layout (Mobile-First) --- */
        :root {
            --brand-red: #A40606;
            --brand-gold: #D98324;
            --wheel-yellow: #fde047;
            --text-dark: #1f2937;
            --text-light: #6b7280;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--brand-red);
            background-image: linear-gradient(315deg, var(--brand-red) 0%, var(--brand-gold) 74%);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            color: var(--text-dark);
        }
        header {
            text-align: center;
            margin-bottom: 1rem;
            z-index: 10;
        }
        .baking-bliss-title {
            font-family: 'Pacifico', cursive;
            /* Using clamp for fluid typography */
            font-size: clamp(2.75rem, 15vw, 4.5rem);
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
            line-height: 1.1;
        }
        header p {
            font-size: clamp(1rem, 4vw, 1.25rem);
            color: white;
            font-weight: 600;
        }
        .main-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }
        .pointer {
            position: absolute;
            top: -0.75rem;
            z-index: 10;
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid var(--wheel-yellow);
            filter: drop-shadow(0 4px 3px rgba(0, 0, 0, 0.07));
        }
        .wheel-container {
            -webkit-tap-highlight-color: transparent;
            position: relative;
            /* Fluid width for wheel */
            width: 85vw;
            height: 85vw;
            max-width: 20rem;
            max-height: 20rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .wheel-svg {
            width: 100%;
            height: 100%;
            transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1);
            filter: drop-shadow(0 0 15px rgba(0,0,0, 0.3));
        }
        .prize-symbol {
             /* Fluid font size for symbols */
            font-size: clamp(1.5rem, 10vw, 3rem);
        }
        .spin-trigger {
            position: absolute;
            width: 5rem;
            height: 5rem;
            background-color: #dc2626;
            border-radius: 9999px;
            border: 4px solid var(--wheel-yellow);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s ease-in-out;
        }
        .spin-trigger:active {
            transform: scale(0.95);
        }
        .spin-trigger span {
            color: white;
            font-size: 1.5rem;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }

        /* --- Modals (CORRECTED & RESPONSIVE) --- */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-panel {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 1.5rem;
            text-align: center;
            width: 90%;
            max-width: 24rem;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        .modal-panel-visible {
            transform: scale(1);
            opacity: 1;
        }
        .modal-content {
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        #prizeName {
            /* Fluid font size for the prize name */
            font-size: clamp(1.5rem, 8vw, 2.25rem);
            font-weight: 700;
            color: var(--text-dark);
            margin: 1rem 0;
            line-height: 1.2;
            word-wrap: break-word;
        }

        /* --- Animations & Utility --- */
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f0f; opacity: 0.7; animation: fall 3s linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .background-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .background-animation .item { position: absolute; bottom: -100px; font-size: 2rem; animation: float 20s linear infinite; opacity: 0.3; color: #FFD700; }
        @keyframes float { 0% { transform: translateY(0) rotate(0deg); opacity: 0.3; } 100% { transform: translateY(-120vh) rotate(720deg); opacity: 0; } }
        .hidden { display: none; }

        /* --- Media Queries for Larger Screens --- */
        @media (min-width: 768px) {
            header {
                margin-bottom: 1.5rem;
            }
            .wheel-container {
                max-width: 24rem;
                max-height: 24rem;
                margin-top: 2rem;
                margin-bottom: 2rem;
            }
             .spin-trigger {
                width: 6rem;
                height: 6rem;
            }
            .spin-trigger span {
                 font-size: 1.875rem;
            }
            .modal-panel { padding: 2rem; }
        }
    </style>
</head>
<body>

    <div class="background-animation" id="background-animation"></div>

    <header>
        <h1 class="baking-bliss-title">Baked Bliss</h1>
        <p>Spin to Win Sweet Treats!</p>
    </header>

    <div class="main-container">
        <div class="pointer"></div>
        <div class="wheel-container">
            <div id="wheel"></div>
            <div id="spinTrigger" class="spin-trigger">
                <span>SPIN</span>
            </div>
        </div>
    </div>
    
    <div id="resultModal" class="modal-backdrop">
        <div id="confetti-container" style="position: absolute; inset: 0; overflow: hidden; pointer-events: none;"></div>
        <div class="modal-panel">
            <div class="modal-content">
                <h2 style="font-size: 1.5rem; font-weight: 900; color: #dc2626; margin-bottom: 0.5rem;">YOU WON!</h2>
                <p id="prizeName"></p>
                <p style="color: var(--text-light); margin-bottom: 1rem;">Show this screen to our staff to redeem!</p>
                <div style="background-color: #f3f4f6; border-radius: 0.5rem; padding: 0.75rem; margin: 1rem 0;">
                    <span style="font-size: 0.875rem; color: var(--text-light);">UNIQUE CODE</span>
                    <p id="prizeId" style="font-size: 1.5rem; font-family: monospace; letter-spacing: 0.1em;"></p>
                </div>
                
                <div id="geminiFeatures" style="margin-top: 1.5rem; display: grid; gap: 1rem;">
                    <div id="geminiButtons" style="display: grid; gap: 0.75rem;">
                        <button id="fortuneButton" style="width: 100%; background-color: #f59e0b; color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 1.125rem; transition: transform 0.2s; border: none; cursor: pointer;">
                            ‚ú® Get Your Sweet Fortune!
                        </button>
                        <button id="funFactButton" style="width: 100%; background-color: #0ea5e9; color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 1.125rem; transition: transform 0.2s; border: none; cursor: pointer;">
                            üßÅ Get a Baker's Fun Fact!
                        </button>
                        <button id="nicknameButton" style="width: 100%; background-color: #8b5cf6; color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 1.125rem; transition: transform 0.2s; border: none; cursor: pointer;">
                            üéâ Name Your Treat!
                        </button>
                    </div>

                    <div id="fortuneContainer">
                        <div id="fortuneLoading" class="hidden" style="margin: 1rem 0; color: var(--text-light);">Baking your fortune... ü•†</div>
                        <div id="fortuneResult" class="hidden" style="margin-top: 1rem; padding: 1rem; background-color: #fef3c7; border-left: 4px solid #f59e0b; color: #92400e; border-radius: 0 0.5rem 0.5rem 0;">
                            <p id="fortuneText" style="font-size: 1.125rem; font-style: italic;"></p>
                        </div>
                    </div>
                    <div id="funFactContainer">
                        <div id="funFactLoading" class="hidden" style="margin: 1rem 0; color: var(--text-light);">Looking up a fun fact... üìú</div>
                        <div id="funFactResult" class="hidden" style="margin-top: 1rem; padding: 1rem; background-color: #e0f2fe; border-left: 4px solid #0ea5e9; color: #075985; border-radius: 0 0.5rem 0.5rem 0;">
                            <p id="funFactText" style="font-size: 1.125rem;"></p>
                        </div>
                    </div>
                    <div id="nicknameContainer">
                        <div id="nicknameLoading" class="hidden" style="margin: 1rem 0; color: var(--text-light);">Inventing a legendary name... ‚ú®</div>
                        <div id="nicknameResult" class="hidden" style="margin-top: 1rem; padding: 1rem; background-color: #f5d0fe; border-left: 4px solid #8b5cf6; color: #6b21a8; border-radius: 0 0.5rem 0.5rem 0;">
                            <p style="color: var(--text-light); font-size: 0.875rem;">Your treat shall henceforth be known as:</p>
                            <p id="nicknameText" style="font-size: 1.5rem; font-weight: 700;"></p>
                        </div>
                    </div>
                </div>
                
                <button id="closeModalButton" style="margin-top: 2rem; width: 100%; background-color: #374151; color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 1.125rem; transition: transform 0.2s; border: none; cursor: pointer;">
                    Awesome!
                </button>
            </div>
        </div>
    </div>

    <div id="alreadySpunModal" class="modal-backdrop">
        <div class="modal-panel">
            <div class="modal-content">
                <div style="font-size: 3.75rem; margin-bottom: 1rem;">ü§î</div>
                <h2 style="font-size: 1.5rem; font-weight: 900; color: var(--text-dark); margin-bottom: 0.5rem;">Whoops!</h2>
                <p style="color: var(--text-light); margin-bottom: 1.5rem;">You've already had your spin for today. Come back tomorrow for another chance to win!</p>
                <button id="closeAlreadySpunModalButton" style="width: 100%; background-color: #ef4444; color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 1.125rem; transition: transform 0.2s; border: none; cursor: pointer;">
                    Got It!
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDauZ3AwxVRK_mvRT89qsXW4g84cgq8Rjc",
            authDomain: "bakingblisswheel.firebaseapp.com",
            projectId: "bakingblisswheel",
            storageBucket: "bakingblisswheel.appspot.com",
            messagingSenderId: "1020604226536",
            appId: "1:1020604226536:web:2d50898e9dc5193d88225d"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, limit, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- DOM Elements ---
        const spinTrigger = document.getElementById('spinTrigger');
        const wheelContainer = document.getElementById('wheel');
        const resultModal = document.getElementById('resultModal');
        const prizeNameEl = document.getElementById('prizeName');
        const prizeIdEl = document.getElementById('prizeId');
        const closeModalButton = document.getElementById('closeModalButton');
        const confettiContainer = document.getElementById('confetti-container');
        const alreadySpunModal = document.getElementById('alreadySpunModal');
        const closeAlreadySpunModalButton = document.getElementById('closeAlreadySpunModalButton');
        const geminiButtons = document.getElementById('geminiButtons');
        const fortuneButton = document.getElementById('fortuneButton');
        const fortuneLoading = document.getElementById('fortuneLoading');
        const fortuneResult = document.getElementById('fortuneResult');
        const fortuneText = document.getElementById('fortuneText');
        const funFactButton = document.getElementById('funFactButton');
        const funFactLoading = document.getElementById('funFactLoading');
        const funFactResult = document.getElementById('funFactResult');
        const funFactText = document.getElementById('funFactText');
        const nicknameButton = document.getElementById('nicknameButton');
        const nicknameLoading = document.getElementById('nicknameLoading');
        const nicknameResult = document.getElementById('nicknameResult');
        const nicknameText = document.getElementById('nicknameText');
        
        // --- Game State & Config ---
        let currentPrize = '';
        let isSpinning = false;
        let db;
        const prizes = [ "CORN CHEESE BASKET @50 EACH (SAVE RS 100)", "CHEESECAKE @120 EACH (SAVE 100)", "KOREAN GARLIC BUN 2@179 (SAVE RS181)", "BUY 2 VANILLA SLICE CAKE @99", "PIZZABURGER @70 (SAVE RS110)+", "ADD ICECREAM TO YOUR BROWNIE AT NO EXTRA COST", "GET VANILLA CUPCAKE FOR RS30 EACH", "‚ÇπCHOCOLATE CUPCAKE - 4@160 (SAVE 200)" ];
        const prizeSymbols = ["üôå", "üç∞", "ü§≥", "üßÅ+üßÅ", "üí∞", "+üßÅ", "üçÄ", "üç´"];
        const dailyStrategies = {
            day1: [ { prize: "CORN CHEESE BASKET @50 EACH (SAVE RS 100)", weight: 10 }, { prize: "GET VANILLA CUPCAKE FOR RS30 EACH", weight: 10 }, { prize: "‚ÇπCHOCOLATE CUPCAKE - 4@160 (SAVE 200)", weight: 10 }, { prize: "BUY 2 VANILLA SLICE CAKE @99", weight: 10 }, { prize: "ADD ICECREAM TO YOUR BROWNIE AT NO EXTRA COST", weight: 10 }, { prize: "CHEESECAKE @120 EACH (SAVE 100)", weight: 10 }, { prize: "PIZZABURGER @70 (SAVE RS110)", weight: 10 }, { prize: "KOREAN GARLIC BUN 2@179 (SAVE RS181)", weight: 10 } ],
            day2: [ { prize: "ADD ICECREAM TO YOUR BROWNIE AT NO EXTRA COST", weight: 10 }, { prize: "‚ÇπCHOCOLATE CUPCAKE - 4@160 (SAVE 200)", weight: 10 }, { prize: "BUY 2 VANILLA SLICE CAKE @99", weight: 10 }, { prize: "GET VANILLA CUPCAKE FOR RS30 EACH", weight: 10 }, { prize: "CORN CHEESE BASKET @50 EACH (SAVE RS 100)", weight: 0 }, { prize: "CHEESECAKE @120 EACH (SAVE 100)", weight: 10 }, { prize: "PIZZABURGER @70 (SAVE RS110)", weight: 0 }, { prize: "KOREAN GARLIC BUN 2@179 (SAVE RS181)", weight: 0 } ],
            day3: [ { prize: "PIZZABURGER @70 (SAVE RS110)+", weight: 10 }, { prize: "ADD ICECREAM TO YOUR BROWNIE AT NO EXTRA COST", weight: 0 }, { prize: "CORN CHEESE BASKET @50 EACH (SAVE RS 100)", weight: 10 }, { prize: "BUY 2 VANILLA SLICE CAKE @99", weight: 0 }, { prize: "‚ÇπCHOCOLATE CUPCAKE - 4@160 (SAVE 200)", weight: 0 }, { prize: "CHEESECAKE @120 EACH (SAVE 100)", weight: 0 }, { prize: "GET VANILLA CUPCAKE FOR RS30 EACH", weight: 0 }, { prize: "KOREAN GARLIC BUN 2@179 (SAVE RS181)", weight: 10 } ],
            day4: [ { prize: "PIZZABURGER @70 (SAVE RS110)+", weight: 30 }, { prize: "ADD ICECREAM TO YOUR BROWNIE AT NO EXTRA COST", weight: 25 }, { prize: "CORN CHEESE BASKET @50 EACH (SAVE RS 100)", weight: 10 }, { prize: "BUY 2 VANILLA SLICE CAKE @99", weight: 15 }, { prize: "‚ÇπCHOCOLATE CUPCAKE - 4@160 (SAVE 200)", weight: 15 }, { prize: "CHEESECAKE @120 EACH (SAVE 100)", weight: 5 }, { prize: "GET VANILLA CUPCAKE FOR RS30 EACH", weight: 3 }, { prize: "KOREAN GARLIC BUN 2@179 (SAVE RS181)", weight: 2 } ],
        };

        // --- Functions ---
        function drawWheel() {
            const numSegments = prizes.length;
            const size = 384; 
            const radius = size / 2;
            const colors = ["#FFFDD0", "#FFFFFF", "#FFFDD0", "#FFFFFF", "#FFFDD0", "#FFFFFF", "#FFFDD0", "#FFFFFF"];
            
            let svgContent = `<svg class="wheel-svg" viewBox="0 0 ${size} ${size}">`;
            for (let i = 0; i < numSegments; i++) {
                const startAngle = i * (360 / numSegments);
                const endAngle = (i + 1) * (360 / numSegments);
                const largeArcFlag = (endAngle - startAngle) <= 180 ? "0" : "1";
                const start = polarToCartesian(radius, radius, endAngle);
                const end = polarToCartesian(radius, radius, startAngle);
                const pathData = `M ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y} L ${radius} ${radius} Z`;
                svgContent += `<path d="${pathData}" fill="${colors[i]}" stroke="#E5E7EB" stroke-width="2" />`;
                const symbolAngle = startAngle + (360 / numSegments) / 2;
                const symbolPosition = polarToCartesian(radius, radius * 0.65, symbolAngle);
                svgContent += `<text x="${symbolPosition.x}" y="${symbolPosition.y}" dy=".3em" text-anchor="middle" class="prize-symbol">${prizeSymbols[i]}</text>`;
            }
            svgContent += `</svg>`;
            wheelContainer.innerHTML = svgContent;
        }

        function polarToCartesian(centerX, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerX + (radius * Math.sin(angleInRadians))
            };
        }
        
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                return getFirestore(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                return null;
            }
        }
        
        function createBackgroundItems() {
            const container = document.getElementById('background-animation');
            for (let i = 0; i < 20; i++) {
                const item = document.createElement('span');
                item.className = 'item';
                item.textContent = ['‚ú®', '‚≠ê', 'üíñ', 'üç∞'][Math.floor(Math.random() * 4)];
                item.style.left = `${Math.random() * 100}vw`;
                item.style.animationDuration = `${15 + Math.random() * 15}s`;
                item.style.animationDelay = `${Math.random() * 10}s`;
                item.style.fontSize = `${1 + Math.random() * 1.5}rem`;
                container.appendChild(item);
            }
        }

        function showModal(modal) {
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.querySelector('.modal-panel').classList.add('modal-panel-visible');
            }, 10);
        }

        function hideModal(modal) {
            modal.querySelector('.modal-panel').classList.remove('modal-panel-visible');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        async function getRiggedPrize(strategy) {
            const availablePrizes = dailyStrategies[strategy]?.filter(s => prizes.includes(s.prize)) || dailyStrategies.day1.filter(s => prizes.includes(s.prize));
            const totalWeight = availablePrizes.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            for (const prize of availablePrizes) {
                if (random < prize.weight) return prizes.indexOf(prize.prize);
                random -= prize.weight;
            }
            return 0;
        }
        
        async function getNextCode() {
            if (!db) return "OFFLINE-" + Math.random().toString(36).substring(2, 8).toUpperCase();
            const counterRef = doc(db, "codes", "counter");
            try {
                let nextCode = "";
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let newCount = counterDoc.exists() ? counterDoc.data().count + 1 : 1;
                    nextCode = "BLISS-" + Math.random().toString(36).substring(2, 6).toUpperCase() + newCount.toString().padStart(3,'0');
                    transaction.set(counterRef, { count: newCount });
                });
                return nextCode;
            } catch (e) {
                console.error("Transaction failed: ", e);
                return "ERROR-CODE";
            }
        }

        async function showResult(prizeIndex) {
            currentPrize = prizes[prizeIndex]; 
            prizeNameEl.textContent = currentPrize;
            prizeIdEl.textContent = "Generating...";
            showModal(resultModal);
            triggerConfetti();

            const uniqueCode = await getNextCode();
            prizeIdEl.textContent = uniqueCode;

            if (db) {
                try {
                    await addDoc(collection(db, "spins"), {
                        prizeWon: currentPrize,
                        uniqueCode: uniqueCode,
                        redeemed: false,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error writing spin to Firestore: ", error);
                }
            }
            
            localStorage.setItem('bakedBlissLastSpin', new Date().toISOString().split('T')[0]);
            geminiButtons.style.display = 'grid';
            [fortuneLoading, fortuneResult, funFactLoading, funFactResult, nicknameLoading, nicknameResult].forEach(el => el.classList.add('hidden'));
        }
        
        async function callGemini(systemPrompt, userQuery) {
            geminiButtons.style.display = 'none';

            // API Key has been added.
            const apiKey = "AIzaSyBH7D6YxyLwyQT254KLEnnHC1fttlql-X0";

            if (apiKey === "PASTE_YOUR_GEMINI_API_KEY_HERE") {
                 console.error("Gemini API Key is missing.");
                 return "The baker is busy! Please check the configuration.";
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "My oven's too hot to think! Try again.";
            } catch (error) {
                console.error("Error fetching from Gemini:", error);
                return "The recipe book is smudged... Please try again!";
            }
        }
        
        // --- Event Listeners ---
        spinTrigger.addEventListener('click', async () => {
            if (isSpinning) return;
            
            let limitSpins = true;
            if (db) {
                const limitRef = doc(db, "config", "spinLimit");
                try {
                    const docSnap = await getDoc(limitRef);
                    if (docSnap.exists() && docSnap.data().enabled === false) limitSpins = false;
                } catch (e) { console.error("Could not check spin limit", e)}
            }
            
            if (limitSpins && localStorage.getItem('bakedBlissLastSpin') === new Date().toISOString().split('T')[0]) {
                showModal(alreadySpunModal);
                return;
            }

            isSpinning = true;
            const wheelSVG = wheelContainer.querySelector('.wheel-svg');
            let winningPrizeIndex = 0;

            if (db) {
                const strategyRef = doc(db, "config", "strategy");
                const docSnap = await getDoc(strategyRef);
                const currentStrategy = docSnap.exists() ? docSnap.data().currentStrategy : "day1";
                winningPrizeIndex = await getRiggedPrize(currentStrategy);
            } else {
                winningPrizeIndex = Math.floor(Math.random() * prizes.length);
            }

            const degreesPerSegment = 360 / prizes.length;
            const totalSpins = 360 * 5; 
            const targetRotation = 360 - (winningPrizeIndex * degreesPerSegment);
            const randomJitter = (Math.random() - 0.5) * (degreesPerSegment * 0.8); 
            const finalRotation = totalSpins + targetRotation + randomJitter;
            
            wheelSVG.style.transform = `rotate(${finalRotation}deg)`;
            setTimeout(() => showResult(winningPrizeIndex), 4100);
        });

        closeModalButton.addEventListener('click', () => { hideModal(resultModal); isSpinning = false; });
        closeAlreadySpunModalButton.addEventListener('click', () => { hideModal(alreadySpunModal); });
        
        fortuneButton.addEventListener('click', async () => {
            fortuneLoading.classList.remove('hidden');
            [funFactResult, nicknameResult].forEach(el => el.classList.add('hidden'));
            const systemPrompt = "You are the joyful baker behind 'Baked Bliss'. Your fortunes are always short (1-2 sentences), sweet, funny, and themed around desserts. Never mention being an AI.";
            const userQuery = `I just won '${currentPrize}'. Give me a sweet, happy fortune related to that!`;
            fortuneText.textContent = await callGemini(systemPrompt, userQuery);
            fortuneLoading.classList.add('hidden');
            fortuneResult.classList.remove('hidden');
        });

        funFactButton.addEventListener('click', async () => {
            funFactLoading.classList.remove('hidden');
            [fortuneResult, nicknameResult].forEach(el => el.classList.add('hidden'));
            const systemPrompt = "You are a cheerful baker at 'Baked Bliss'. Provide a single, fascinating fun fact or creative serving suggestion. Keep it short and exciting. Never mention being an AI.";
            const userQuery = `Based on my prize ('${currentPrize}'), give me a fun fact. If generic, a general cake fact.`;
            funFactText.textContent = await callGemini(systemPrompt, userQuery);
            funFactLoading.classList.add('hidden');
            funFactResult.classList.remove('hidden');
        });

        nicknameButton.addEventListener('click', async () => {
            nicknameLoading.classList.remove('hidden');
            [fortuneResult, funFactResult].forEach(el => el.classList.add('hidden'));
            const systemPrompt = "You are a creative naming expert for desserts. Give a single, epic, quirky nickname. Respond with ONLY the nickname in quotation marks.";
            const userQuery = `Give a nickname to the prize I won: '${currentPrize}'. If generic, nickname 'a lucky moment'.`;
            const nickname = await callGemini(systemPrompt, userQuery);
            nicknameText.textContent = nickname.trim().replace(/"/g, '');
            nicknameLoading.classList.add('hidden');
            nicknameResult.classList.remove('hidden');
        });

        function triggerConfetti() {
            confettiContainer.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                const colors = ['#f87171', '#fb923c', '#facc15', '#4ade80', '#38bdf8', '#a78bfa'];
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * -3 + 's';
                confettiContainer.appendChild(confetti);
            }
        }

        // --- Initial Page Load ---
        drawWheel();
        createBackgroundItems();
        db = initializeFirebase();
    </script>
</body>
</html>

